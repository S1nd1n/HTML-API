<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Document</title>
  <style>
    body {
      font: 1em sans-serif;
    }

    .todo {
      width: 500px;
      margin: auto;
      font-size: 0.8em;
      /* border: 1px solid #000;*/
    }

    .todo .input {
      width: 100%;
      font: 2em sans-serif;
      box-sizing: border-box
    }

    .todo .done li {
      text-decoration: line-through;
    }

    .todo li a {
      margin-left: 10px;
    }
  </style>
</head>

<body>

  <!-- 
   Создать список дел, используя IndexedDB
   Разметку можно взять тут https://codepen.io/htmllabru/pen/mqyqpG
   -->
  <div class="todo">
    <h1>To Do List</h1>
    <input type="text" placeholder="добавьте дело">
    <input type="text" placeholder="длительность в минутах">
    <h3>Список дел</h3>
    <ul class="plan"></ul>
    <h3>Выполненные дела</h3>
    <ul class="done"></ul>
    <h3>Топ5 задач по длительности</h3>
    <pre class="top5duration"></pre>
  </div>
  <script>
    //получаем ссылки на основные элементы
    let
      todo = document.querySelector(".todo"),
      input = document.querySelector(".todo input"),
      plan = document.querySelector(".todo .plan"),
      done = document.querySelector(".todo .done");

    //когда Enter - добавляем дело с список дел
    input.onchange = function () {
      //создаём новое дело
      let li = document.createElement("li");
      li.innerHTML = this.value;

      //чистим поле ввода
      this.value = "";

      //запоминаем что дело не выполнено
      li.status = "plan";

      //меняем вид дела
      li.onclick = function () {
        this.className = this.status = this.status == "plan" ? "done" : "plan";
        switch (this.status) {
          case "plan": plan.appendChild(this); break;
          case "done": done.appendChild(this); break;
        }
      }

      //обрабатываем удаление дела
      let a = document.createElement("a");
      a.innerHTML = "Удалить";
      a.href = "#";
      a.onclick = function (ev) {
        ev.preventDefault();
        ev.stopPropagation();
        this.parentNode.parentNode.removeChild(this.parentNode);
      }
      li.appendChild(a);

      //добавляем в соответствующий список
      plan.appendChild(li);
    }
  </script>
  <script>
    // ссылка на элемен ввода названия задания
    let taskInput = document.querySelector('input');
    // ссылка на элемен ввода длительности задания
    let durationInput = document.querySelectorAll('input')[1];

    // по нажатию на Enter добавляем задание в базу
    taskInput.addEventListener('keyup', ev => {
      if (ev.target.value.trim() && ev.keyCode == 13) {
        let request = db.transaction('tasks', 'readwrite')
          .objectStore('tasks')
          .add({ title: ev.target.value, state: 'uncompleted', duration: +durationInput.value });

        // чистим поле ввода
        ev.target.value = '';
        ev.target.focus();

        // заново отрисовываем результат
        showTasks();
      }
    })

    // переменная для базы данных
    let db;

    // запрос на открытие/создание базы
    let request = indexedDB.open('ToDoList', 1);

    // назначаем обработчик ошибки
    request.addEventListener('error', ev => {
      console.log(ev);
    });

    // назначаем обработчик открытия
    request.addEventListener('success', ev => {
      db = ev.target.result;

      console.log('база открыта', db);
      console.log(ev);
    });

    // назначаем обработчик обновления/создания
    request.addEventListener('upgradeneeded', ev => {
      console.log('база создана/обновлена');
      db = ev.target.result;

      // создание хранилища с ключем
      let objectStore = db.createObjectStore("tasks", {
        keyPass: 'id',
        autoIncrement: true
      });
      let durationIndex = objectStore.createIndex('ixduration', 'duration');

      // добавляем задачу
      objectStore.add({
        title: 'Задача1',
        state: 'uncompleted',
        duration: 10
      })
      objectStore.add({
        title: 'Задача2',
        state: 'completed',
        duration: 25
      })
      objectStore.add({
        title: 'Задача3',
        state: 'completed',
        duration: 15
      })
      objectStore.add({
        title: 'Задача4',
        state: 'uncompleted',
        duration: 49
      })
    });

    /**
     * showTasks отображает задачи в HTML-списках
     * 
     */
    function showTasks() {
      let ulCompletedTask = document.querySelector('.plan');
      let ulUncompletedTask = document.querySelector('.done');
      let preTop5DurationTask = document.querySelector('.top5duration');

      // чистим содержимое
      ulCompletedTask.innerHTML = '';
      ulUncompletedTask.innerHTML = '';
      preTop5DurationTask.innerHTML = '';

      // получаем ссылку на объект-хранилище
      let objectStore = db
        .transaction('tasks')
        .objectStore('tasks');

      // добавление записей при проходе с курсором
      objectStore.openCursor().addEventListener('success', ev => {
        // ссылку на очередную позицию
        let cursor = ev.target.result;

        // проход с курсором по записям
        if (cursor) {
          console.log(cursor.value);

          // создаем List item для списка
          let li = document.createElement('li');

          // указываем идентификатор записи
          li.setAttribute('data-id', cursor.value.id);

          // название задачи
          let textLi = document.createTextNode(cursor.value.title);
          li.appendChild(textLi);

          // создаем и добавляем ссылку на удаление
          let a = document.createElement('a');
          a.innerHTML = 'Удалить';
          a.addEventListener('click', ev => {
            ev.preventDefault();
            let parent = ev.target.parentNode;

            let request = db.transaction('tasks', 'readwrite')
              .objectStore('tasks')
              .delete(+parent.getAttribute('data-id'));

            // удаляем элемент списка из HTML
            parent.remove();
          })
          a.setAttribute('href', '#')
          li.appendChild(a);

          let ulTask = cursor.value.state == 'completed' ? ulUncompletedTask : ulCompletedTask;
          ulTask.appendChild(li);

          li.addEventListener('click', ev => {

            // id зыписи, статус которой меняем
            let id = +ev.target.getAttribute('data-id');

            // получаем ссылку на объект-хранилище
            let objectStore = db.transaction('tasks', 'readwrite').objectStore('tasks')

            // получаем ссылку на задачу по id
            console.log(objectStore.get(id))
            let request = objectStore.get(id);

            request.addEventListener('success', ev => {
              let task = ev.target.result;

              // меняем состояние задачи
              db.transaction('tasks', 'readwrite')
                .objectStore('tasks')
                .put({
                  ...task,
                  id, state: task.state == 'completed' ? 'uncmpleted' : 'completed'
                });
              showTasks();
            })
          })
          cursor.continue();
        }
      })
      let durationIndex = db
        .transaction('tasks')
        .objectStore('tasks')
        .index('ixduration');

      let request = durationIndex.getAll(IDBKeyRange.lowerBound(15));

      request.addEventListener('success', ev => {
        preTop5DurationTask.innerHTML = JSON.stringify(
          request.result.sort((a, b) => b.duration - a.duration).slice(0, 5),
          null,
          ' '
        )
      })
    }

    setTimeout(() => { showTasks() }, 100);
  </script>
</body>

</html>